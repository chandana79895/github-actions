name: CI

on:
  pull_request:
    types: [closed]
    branches:
      - develop

jobs:
  track-and-build:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true  
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config --global user.email "manichandana7989@gmail.com"
          git config --global user.name "chandana79895"

      - name: Fetch Latest Changes
        run: git pull origin develop

      - name: Increment PR Counter
        id: pr_counter
        run: |
          COUNTER_FILE="pr_counter.txt"

          # Fetch current PR counter
          if [ -f $COUNTER_FILE ]; then
            COUNTER=$(cat $COUNTER_FILE)
          else
            COUNTER=0
          fi

          # Increment counter
          COUNTER=$((COUNTER + 1))
          echo $COUNTER > $COUNTER_FILE
          echo "Current PR Counter: $COUNTER"

          # Commit updated counter
          git add $COUNTER_FILE
          git commit -m "Update PR Counter to $COUNTER"
          git remote set-url origin https://${{ secrets.GH_PAT }}@github.com/chandana79895/github-actions.git
          git push origin develop

      - name: Trigger Build if 4-5 PRs Merged
        if: |
          steps.pr_counter.outputs.counter == 4 || 
          steps.pr_counter.outputs.counter == 5
        run: echo "Triggering the build as 4-5 PRs have been merged."

      - name: Reset Counter After Build Trigger
        if: |
          steps.pr_counter.outputs.counter == 4 || 
          steps.pr_counter.outputs.counter == 5
        run: |
          echo 0 > pr_counter.txt
          git add pr_counter.txt
          git commit -m "Reset PR Counter"
          git push origin develop


  build:
    needs: track-and-build
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git user
        run: |
          git config --global user.email "manichandana7989@gmail.com"
          git config --global user.name "chandana79895"  

      - name: Bump version
        run: |
          npm version patch --no-git-tag-version

      - name: Dependency after version update
        run: npm ci    

      - name: Push changes
        run: |
          git add package.json package-lock.json
          git commit -m "Bump version new"
          git remote set-url origin https://${{ secrets.GH_PAT }}@github.com/chandana79895/github-actions.git
          git push origin develop